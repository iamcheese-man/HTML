<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Chat System" />
<link rel="apple-touch-icon" href="icon.png" />
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Firebase Chat with Nickname Login</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #007aff, #5856d6);
    color: #fff;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; min-height: 100vh;
  }
  header {
    padding: 1rem; text-align: center; font-size: 1.8rem; font-weight: 700;
    background: rgba(0,0,0,0.2);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }
  #auth-container, #chat-container {
    max-width: 420px;
    margin: 1rem auto;
    background: rgba(0,0,0,0.25);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  }
  label {
    display: block;
    margin: 0.5rem 0 0.2rem 0;
    font-weight: 600;
  }
  input[type="text"], input[type="email"], input[type="password"] {
    width: 100%;
    padding: 0.5rem;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
  }
  button {
    margin-top: 1rem;
    width: 100%;
    padding: 0.7rem;
    border-radius: 12px;
    border: none;
    background: #00e0ff;
    color: #000;
    font-weight: 700;
    font-size: 1.1rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  button:disabled {
    background: #004d4d;
    cursor: not-allowed;
  }
  #toggle-auth {
    margin-top: 0.7rem;
    background: transparent;
    color: #bbdefb;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    border: none;
    text-decoration: underline;
  }
  #chat-messages {
    height: 280px;
    overflow-y: auto;
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 1rem;
    font-size: 1rem;
    margin-bottom: 1rem;
    color: #fff;
  }
  .message {
    margin-bottom: 0.7rem;
  }
  .message strong {
    color: #00e0ff;
  }
  #chat-input {
    display: flex;
    gap: 0.5rem;
  }
  #chat-input input {
    flex-grow: 1;
    padding: 0.6rem;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
  }
  #logout-btn {
    margin-top: 0.5rem;
    background: #ff3b3b;
    color: white;
  }
  #clear-chat-btn {
    background: #ffaa00;
    color: #000;
    margin-top: 0.5rem;
  }
</style>
</head>
<body>
<header>Firebase Chat with Nickname Login</header>

<div id="auth-container">
  <label for="nickname-input" id="nickname-label">Nickname</label>
  <input type="text" id="nickname-input" placeholder="Your nickname" autocomplete="off" />
  
  <label for="email-input">Email</label>
  <input type="email" id="email-input" placeholder="Email" autocomplete="off" />
  
  <label for="password-input">Password</label>
  <input type="password" id="password-input" placeholder="Password" autocomplete="off" />
  
  <button id="auth-btn">Sign Up</button>
  <button id="toggle-auth">Switch to Login</button>
</div>

<div id="chat-container" style="display:none;">
  <div id="chat-messages"></div>
  <div id="chat-input">
    <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" />
    <button id="send-btn">Send</button>
  </div>
  <button id="clear-chat-btn">Clear Chat (Client)</button>
  <button id="logout-btn">Logout</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    signOut, 
    onAuthStateChanged, 
    updateProfile,
    reload
  } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
  import { 
    getDatabase, 
    ref, 
    push, 
    onChildAdded, 
    serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAOp2Gr7PaOHgY3HUMU1eKm7VMZAmIG-UY",
    authDomain: "chatting-4d46f.firebaseapp.com",
    projectId: "chatting-4d46f",
    storageBucket: "chatting-4d46f.firebasestorage.app",
    messagingSenderId: "128861079609",
    appId: "1:128861079609:web:da9cb3933b7588246565e8",
    measurementId: "G-XZ7H22MQ3H"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const authContainer = document.getElementById('auth-container');
  const chatContainer = document.getElementById('chat-container');
  const nicknameInput = document.getElementById('nickname-input');
  const emailInput = document.getElementById('email-input');
  const passwordInput = document.getElementById('password-input');
  const authBtn = document.getElementById('auth-btn');
  const toggleAuthBtn = document.getElementById('toggle-auth');
  const chatMessages = document.getElementById('chat-messages');
  const messageInput = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const clearChatBtn = document.getElementById('clear-chat-btn');

  let isLoginMode = false; // false = signup, true = login

  function setLoading(isLoading) {
    authBtn.disabled = isLoading;
    toggleAuthBtn.disabled = isLoading;
    sendBtn.disabled = isLoading;
    logoutBtn.disabled = isLoading;
    clearChatBtn.disabled = isLoading;
  }

  toggleAuthBtn.onclick = () => {
    isLoginMode = !isLoginMode;
    if (isLoginMode) {
      authBtn.textContent = 'Login';
      toggleAuthBtn.textContent = 'Switch to Sign Up';
      nicknameInput.style.display = 'none';
    } else {
      authBtn.textContent = 'Sign Up';
      toggleAuthBtn.textContent = 'Switch to Login';
      nicknameInput.style.display = 'block';
    }
  };

  authBtn.onclick = async () => {
    setLoading(true);
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    const nickname = nicknameInput.value.trim();

    if (!email || !password || (!isLoginMode && !nickname)) {
      alert('Please fill all required fields.');
      setLoading(false);
      return;
    }

    try {
      if (isLoginMode) {
        await signInWithEmailAndPassword(auth, email, password);
      } else {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        // Update displayName (nickname)
        await updateProfile(userCredential.user, { displayName: nickname });
        // Reload user to get updated profile
        await reload(userCredential.user);
      }
    } catch (error) {
      alert(error.message);
      console.error(error);
    }
    setLoading(false);
  };

  logoutBtn.onclick = async () => {
    setLoading(true);
    try {
      await signOut(auth);
    } catch (e) {
      console.error(e);
    }
    setLoading(false);
  };

  clearChatBtn.onclick = () => {
    chatMessages.innerHTML = '';
  };

  onAuthStateChanged(auth, async user => {
    if (user) {
      // Reload user to make sure displayName is fresh (fixes anonymous name)
      await reload(user);

      authContainer.style.display = 'none';
      chatContainer.style.display = 'block';
      chatMessages.innerHTML = '';
      listenForMessages();
    } else {
      authContainer.style.display = 'block';
      chatContainer.style.display = 'none';
    }
  });

  sendBtn.onclick = async () => {
    const msg = messageInput.value.trim();
    if (!msg) return;

    setLoading(true);

    try {
      const user = auth.currentUser;
      if (!user) throw new Error('Not logged in');

      const messagesRef = ref(db, 'messages');
      await push(messagesRef, {
        text: msg,
        sender: user.displayName || 'Anonymous',
        timestamp: serverTimestamp()
      });

      messageInput.value = '';
    } catch (e) {
      alert('Error sending message: ' + e.message);
      console.error(e);
    }

    setLoading(false);
  };

  function listenForMessages() {
    const messagesRef = ref(db, 'messages');
    onChildAdded(messagesRef, snapshot => {
      const msg = snapshot.val();
      const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : '';
      const div = document.createElement('div');
      div.classList.add('message');
      div.innerHTML = `<strong>${msg.sender}</strong> [${time}]: ${msg.text}`;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
  }
</script>

</body>
</html>
