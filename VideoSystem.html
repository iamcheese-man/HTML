<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Synchronized Video Player</title>
<style>
  body, html { margin:0; padding:0; height:100%; }
  #login, #upload { display:none; flex-direction:column; gap:8px; padding:20px; }
  #videoContainer {
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:black; z-index:999; display:none;
    justify-content:center; align-items:center;
  }
  video, iframe {
    max-width:100%; max-height:100%;
    box-shadow:0 0 40px rgba(0,0,0,0.7);
  }
  #banner {
    position:absolute; top:10px;
    background:rgba(0,0,0,0.6); padding:8px 16px; border-radius:8px;
    font-size:1.2rem; color:#fff;
  }
  button,input { padding:8px; font-size:1rem; }
</style>
</head>
<body>
<div id="login">
  <h2>Login / Register</h2>
  <input id="email" placeholder="Email" type="email">
  <input id="password" placeholder="Password" type="password">
  <input id="nickname" placeholder="Nickname">
  <button onclick="authUser()">Submit</button>
</div>

<div id="upload">
  <h2>Share Video</h2>
  <button onclick="pickSource()">Pick Source</button>
  <p id="status"></p>
  <input type="file" id="fileInput" accept="video/*" style="display:none">
</div>

<div id="videoContainer">
  <div id="banner"></div>
  <video id="sharedVideo" controls style="display:none"></video>
  <iframe id="sharedIframe" frameborder="0" allowfullscreen style="display:none"></iframe>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
  // Firebase Setup
  const cfg = { /* ðŸ¤– your config here */ databaseURL: "https://project-videoshare-default-rtdb.firebaseio.com/" };
  firebase.initializeApp(cfg);
  const auth = firebase.auth(), db = firebase.database();

  // Element refs
  const login = document.getElementById('login'),
        upload = document.getElementById('upload'),
        emailEl = document.getElementById('email'),
        pwdEl = document.getElementById('password'),
        nickEl = document.getElementById('nickname'),
        fileInput = document.getElementById('fileInput'),
        status = document.getElementById('status'),
        videoContainer = document.getElementById('videoContainer'),
        sharedVideo = document.getElementById('sharedVideo'),
        sharedIframe = document.getElementById('sharedIframe'),
        banner = document.getElementById('banner');

  let nickname = '';
  auth.onAuthStateChanged(u => {
    if (u) { login.style.display='none'; upload.style.display='flex'; watchVideo(); }
    else { upload.style.display='none'; login.style.display='flex'; }
  });

  async function authUser(){
    const email = emailEl.value.trim(), pwd = pwdEl.value, nick = nickEl.value.trim();
    if (!email || !pwd || !nick) return alert('Fill all fields');
    nickname = nick;
    try {
      await auth.signInWithEmailAndPassword(email, pwd);
    } catch {
      await auth.createUserWithEmailAndPassword(email, pwd);
    }
  }

  function pickSource(){
    const txt = prompt("Enter YouTube link or type 'file':").trim();
    if (!txt) return;
    if (txt.toLowerCase()==='file') fileInput.click();
    else uploadSource(txt, extractName(txt));
  }

  fileInput.onchange = e => {
    const f = e.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = () => uploadSource(reader.result, f.name);
    reader.readAsDataURL(f);
  };

  function extractName(u) {
    try {
      const url = new URL(u);
      if (url.hostname.includes('youtube.com') || url.hostname.includes('youtu.be'))
        return url.searchParams.get('v') || url.pathname.split('/').pop();
    } catch {}
    return u.split('/').pop();
  }

  function uploadSource(src, name){
    db.ref('currentVideo').once('value').then(s => {
      if (s.exists()) return status.textContent='Already playing!';
      db.ref('currentVideo').set({ src, name, by: nickname });
    });
  }

  function watchVideo(){
    db.ref('currentVideo').on('value', snap => {
      const d = snap.val();
      if (!d) { hidePlayer(); return; }

      banner.textContent = `${d.by} is playing "${d.name}"`;
      if (d.src.startsWith('data:') || d.src.endsWith('.mp4')) showVideo(d.src);
      else showIframe(d.src);
    });
  }

  function showVideo(src){
    sharedIframe.style.display='none';
    sharedVideo.src = src;
    sharedVideo.style.display='block';
    videoContainer.style.display='flex';
    sharedVideo.play();
  }

  function showIframe(src){
    sharedVideo.style.display='none';
    sharedIframe.src = src;
    sharedIframe.style.display='block';
    videoContainer.style.display='flex';
  }

  function hidePlayer(){
    videoContainer.style.display='none';
    sharedVideo.pause();
    sharedVideo.src = '';
    sharedIframe.src = '';
  }

  // Prevent clicks through overlay
  videoContainer.addEventListener('click', e => e.stopPropagation());
</script>
</body>
</html>
